# 云图项目设计文档

## 项目概述

云图-CloudPic是一个Web应用，旨在连接和管理多个云存储服务（如Backblaze B2、Cloudflare R2），提供文件的上传、删除、预览等功能。用户通过单一访问密码进行身份验证。

## 项目架构设计

### 总体架构

项目采用前后端分离的架构，前端负责用户界面和交互，后端负责业务逻辑和数据处理。架构设计强调扩展性和低耦合性，特别是在云存储服务的认证连接部分。

### 前端架构

- **框架**：使用 **React ^18.2.0**，因其组件化开发、生态丰富且性能优越。
- **UI框架**：使用 **Tailwind CSS ^3.4.0** 构建现代化UI界面。
- **路由管理**：使用 **React Router ^6.8.0** 管理页面路由。
- **HTTP客户端**：使用 **Axios ^1.6.2** 处理API请求。
- **状态管理**：使用 **React Context** 进行全局状态管理。
- **多语言支持**：使用 **i18next ^22.4.0** 实现多语言支持。
- **组件设计**：
  - **容器组件**：负责数据获取和逻辑处理。
  - **展示组件**：负责界面渲染和用户交互。
- **主题模式**：
  - 支持白天和黑夜两种主题模式，用户可以在设置中切换。
  - 使用CSS变量或Styled Components实现主题切换。

### 后端架构

- **框架**：使用 **Node.js ^18.0.0 + Express ^4.18.2** 构建RESTful API。
- **认证机制**：
  - 通过环境变量 `ACCESS_PASSWORD` 设置访问密码
  - 前端存储验证状态：`localStorage.setItem('isAuthenticated', 'true')`
  - 无需复杂的token机制，因文件操作直接使用云存储服务的API
- **文件处理限制**：
  - 文件大小限制：100MB
  - 支持文件类型：图片（JPEG、PNG、GIF）
  - 使用 sharp 库处理图片压缩和缩略图生成
- **日志记录**：
  - 前端：记录文件操作日志（上传/删除）
  - 后端：记录访问日志（IP、时间、操作类型）和错误日志
- **数据存储方案**：
  - **存储连接信息**：使用 **Vercel的数据库** 存储用户的连接信息，包括：
     - 已连接的存储桶列表
     - 每个存储桶的认证信息（如API密钥）
     - 其他相关设置
  - **访问日志**：记录用户的访问日志，以便后续分析和优化。

- **API设计**：
  - **用户认证API**：处理登录请求。
  - **存储服务API**：管理云存储服务的连接、文件操作等。
  - **文件操作API**：实现文件的上传、删除、预览等功能。

### 云存储服务扩展性设计

1. **统一接口设计**：
   - 定义 `IStorageService` 接口，包含以下核心方法：
     - `connect`: 连接并认证存储服务
     - `uploadFile`: 上传文件
     - `deleteFile`: 删除文件
     - `listFiles`: 列出文件
     - `getFileUrl`: 获取文件访问URL
     - `createDirectory`: 创建目录（可选）

2. **存储服务实现**：
   a. **Backblaze B2实现**
   - 使用官方SDK `backblaze-b2`
   - 需要自定义TypeScript类型定义
   - 实现文件上传、删除、列表等操作

   b. **Cloudflare R2实现**
   - 使用 `@aws-sdk/client-s3` SDK（R2兼容S3 API）
   - 配置R2专用endpoint
   - 实现标准S3操作接口

   c. **通用S3兼容服务实现**
   - 同样使用 `@aws-sdk/client-s3` SDK
   - 支持自定义endpoint和region
   - 添加特殊配置支持（如 `forcePathStyle`）

3. **服务工厂模式**：
   - 使用工厂模式创建存储服务实例
   - 支持动态选择存储服务类型
   - 统一配置管理

4. **认证连接模块**：
   - 将认证逻辑封装在独立模块中
   - 支持不同服务的认证方式
   - 通过数据库存储认证信息

### 目录结构

```
/cloudpic
├── /public              # 静态文件
├── /src                 # 源代码
│   ├── /components      # 组件
│   ├── /pages           # 页面
│   ├── /services        # 服务层
│   │   ├── /auth        # 认证模块
│   │   ├── /storage     # 存储服务模块
│   │   │   ├── IStorageService.js  # 存储服务接口
│   │   │   ├── B2Service.js        # B2服务实现
│   │   │   └── R2Service.js        # R2服务实现
│   ├── /utils           # 工具函数
│   ├── /themes          # 主题相关
│   ├── /locales         # 多语言资源
│   └── App.js           # 主应用文件
├── .env                 # 环境变量配置
├── package.json         # 项目依赖
└── README.md            # 项目说明
```

### 交互流程

1. **用户登录**：
   - 用户访问登录页面，输入访问密码。
   - 前端将密码发送至后端进行验证。
   - 验证通过后，跳转至主页。

2. **添加存储连接**：
   - 用户点击"添加连接"按钮，弹出连接弹窗。
   - 用户选择云存储服务商并填写认证信息。
   - 前端将信息发送至后端，后端验证并保存连接信息。

3. **文件操作**：
   - 用户在文件列表中选择文件进行操作（上传、删除、预览）。
   - 前端发送相应请求至后端，后端调用云存储服务的API执行操作。
   - 操作完成后，返回结果给前端并更新界面。

## 用户界面布局和交互逻辑

### 1. 登录页

- **功能**：用户输入访问密码进行身份验证。
- **布局**：
  - 输入框：用于输入访问密码。
  - 登录按钮：提交密码进行验证。
  - 提示信息：显示登录成功或失败的消息。

### 2. 主页

- **功能**：展示已连接的存储服务和文件列表。
- **布局**：
  - **顶部**：
    - 项目Logo和名称
    - 添加连接按钮
    - 登出按钮
    - 主题切换按钮
    - 语言切换按钮
  - **左侧导航栏**：
    - 显示已连接的存储服务（如B2、R2）
    - 点击服务后，右侧显示对应的文件列表
  - **右侧文件区域**：
    - 显示文件列表，包含文件的缩略图、名称、大小、修改时间等信息。
    - 文件操作按钮（删除、移动等）位于文件列表上方。

### 3. 连接弹窗

- **功能**：用户可以添加新的存储连接。
- **布局**：
  - 服务商列表：展示支持的云存储服务商的图标和名称。
  - 认证表单：根据选择的服务商展示相应的认证表单（如API密钥、存储桶名称等）。
  - 提交按钮：提交认证信息进行连接。

### 4. 文件列表组件

- **功能**：展示文件和文件夹，支持预览和操作。
- **布局**：
  - 上方导航：显示当前路径（如首页/文件夹名），包含文件和文件夹的操作按钮。
  - 文件操作按钮：包括上传、下载、删除、新增目录等操作。
  - 文件列表：
    - grid和list两种样式切换。
    - 每个文件或文件夹旁边有选择框，以便进行批量操作。
    - 文件预览组件：点击文件后，展示美观的预览界面。需要注意对文件夹的操作不是预览，而是进入到文件夹内部，查询新的文件列表。

### 5. 返回信息提示

- **功能**：根据请求结果提供用户反馈。
- **布局**：
  - 成功或失败的消息提示框，位于页面顶部。

### 6. 404页面

- **功能**：处理未找到页面的情况。
- **布局**：
  - 提示用户页面未找到的信息。
  - 返回主页的按钮。

## Vercel一键部署

1. **创建Vercel项目**：
   - 在Vercel官网注册并创建新项目。
   - 将代码库（如GitHub）连接到Vercel。

2. **配置环境变量**：
   - 在Vercel项目设置中添加环境变量：
     - `ACCESS_PASSWORD`：访问密码

3. **简单部署**：
   - 确保项目的 `package.json` 中包含启动脚本。
   - 提交代码后，Vercel会自动构建并部署项目。

## 本地开发说明

1. **云存储服务开发**：
   - 直接使用B2/R2的API进行开发和测试
   - 创建专门用于测试的存储桶
   - 确保测试桶的API密钥权限配置正确

2. **数据存储替代方案**：
   - 本地开发时使用JSON文件存储配置信息（存储桶连接信息等）
   - 部署到Vercel时再切换到Vercel数据库服务
   - 数据结构保持一致，只是存储方式不同

3. **访问认证处理**：
   - 本地开发时使用配置文件中的测试密码
   - 部署到Vercel时使用环境变量中的实际密码

## 其他注意事项

1. **代码注释**：确保代码中有充分的注释，便于理解。
2. **API文档**：使用真实有效的API文档，确保调用的库和方法正确。
3. **测试**：在本地开发过程中，无法先将项目部署到vercle中，所以考虑到本地测试的情况，先模拟，确保功能正常。 